# Build Utilities

This directory contains utilities used during the build process and runtime for configuration validation and build-time operations.

## ðŸ“ Files Overview

### `buildConfig.js`
**Purpose:** Global build configuration and section registry

**Key Features:**
- Defines default preloaded sections
- Configures Tailwind ignore patterns
- Sets asset preload configurations
- Manages bundle and manifest naming conventions

**Used By:**
- Vite build process
- Section preloader
- Tailwind CSS scanner
- Manifest generator

**Key Exports:**
- `DEFAULT_PRELOADED_SECTIONS` - Sections to preload on startup
- `TAILWIND_IGNORE_PATTERNS` - Component ignore patterns
- `ASSET_PRELOAD_CONFIG` - Asset preload configuration
- `MANIFEST_CONFIG` - Manifest generation settings

---

### `envValidator.js`
**Purpose:** Environment variable validation utility

**Key Features:**
- Validates required and optional env vars
- Supports environment-specific validation rules
- Custom validation functions per variable
- Fails builds if critical vars missing in production
- Provides detailed error messages and warnings

**Used By:**
- `main.js` - On application startup
- Build scripts - Pre-build validation
- CI/CD pipelines - Deployment validation

**Key Exports:**
- `validateEnvironmentVariables(environment, envVars, throwOnError)` - Main validation function
- `validateOnStartup()` - Validate on app startup
- `getRequiredEnvVars(environment)` - Get required vars list
- `getOptionalEnvVars(environment)` - Get optional vars list
- `printEnvSummary(environment)` - Print env vars summary
- `getAllEnvRequirements()` - Get full requirements config
- `ENV_REQUIREMENTS` - Configuration object

**Configuration:**

Environment requirements are defined in the `ENV_REQUIREMENTS` object:

```javascript
{
  development: {
    required: ['VITE_ENABLE_LOGGER', 'VITE_AUTH_DEV_SHIM'],
    optional: ['VITE_COGNITO_USER_POOL_ID', ...],
    validation: {
      'VITE_ENABLE_LOGGER': (value) => value === 'true' || value === 'false',
      ...
    }
  },
  production: {
    required: ['VITE_ENABLE_LOGGER', 'VITE_COGNITO_USER_POOL_ID', ...],
    optional: [...],
    validation: {...}
  }
}
```

**Usage Example:**

```javascript
import { validateEnvironmentVariables, printEnvSummary } from './envValidator.js';

// Validate current environment
const result = validateEnvironmentVariables('production', import.meta.env);

if (!result.valid) {
  console.error('Validation failed:', result.errors);
}

// Print summary
printEnvSummary('production');
```

**Validation Process:**

1. **Required Variables:**
   - Must be present and not empty
   - Must pass custom validation if defined
   - Build fails if missing

2. **Optional Variables:**
   - Warnings if missing
   - Must pass validation if present and validator defined
   - Build continues

3. **Validation Functions:**
   - Boolean validation: `'true'` or `'false'`
   - String validation: Not empty, not placeholder
   - Format validation: Regex patterns (e.g., AWS region)
   - Custom validation: Any function returning boolean

**Error Output:**

```
âŒ Environment validation failed for "production":
Missing required environment variable: VITE_COGNITO_USER_POOL_ID
Invalid value for environment variable: VITE_COGNITO_CLIENT_ID = "YOUR_CLIENT_ID_HERE"
```

**Integration Points:**

1. **Application Startup (`main.js`):**
   ```javascript
   import { validateOnStartup } from './utils/build/envValidator.js';
   
   try {
     const result = validateOnStartup();
     console.log('âœ… Environment validation passed');
   } catch (error) {
     console.error('âŒ Environment validation failed:', error.message);
     if (!import.meta.env.DEV) {
       throw error; // Fail in production
     }
   }
   ```

2. **Build Scripts:**
   ```javascript
   // In vite.config.js or build script
   import { validateEnvironmentVariables } from './src/utils/build/envValidator.js';
   
   const result = validateEnvironmentVariables('production', process.env, true);
   ```

3. **CI/CD Pipelines:**
   ```bash
   # Add to your CI/CD script
   npm run validate-env
   ```

---

### `manifestLoader.js`
**Purpose:** Load and parse section manifests generated by Vite

**Key Features:**
- Loads section bundle paths from manifests
- Handles development vs production manifest loading
- Caches manifest data for performance
- Provides bundle path resolution

**Used By:**
- Section preloader
- Route guard system
- Asset loader

**Key Exports:**
- `getSectionBundlePaths(sectionName)` - Get bundle paths for a section
- `loadManifestForSection(sectionName)` - Load manifest file
- `getAllLoadedManifests()` - Get all loaded manifests
- `clearManifestCache()` - Clear manifest cache

---

## ðŸ”§ Configuration Files

### `config/envRequirements.json`
**Purpose:** JSON schema for environment variable requirements

**Structure:**
```json
{
  "environments": {
    "development": {
      "required": [
        {
          "name": "VITE_ENABLE_LOGGER",
          "type": "boolean",
          "description": "Enable/disable logging",
          "default": "true",
          "validValues": ["true", "false"]
        }
      ],
      "optional": [...]
    },
    "production": {...},
    "test": {...}
  }
}
```

**Used By:**
- Documentation generation
- IDE autocomplete
- Validation tools

---

## ðŸ“‹ Usage Guidelines

### Adding New Environment Variables

1. **Update `.env.example`:**
   ```bash
   # Add the new variable with description
   VITE_NEW_FEATURE_FLAG=true
   ```

2. **Update `envValidator.js`:**
   ```javascript
   const ENV_REQUIREMENTS = {
     development: {
       required: [
         'VITE_ENABLE_LOGGER',
         'VITE_NEW_FEATURE_FLAG'  // Add here
       ],
       validation: {
         'VITE_NEW_FEATURE_FLAG': (value) => value === 'true' || value === 'false'
       }
     }
   }
   ```

3. **Update `config/envRequirements.json`:**
   ```json
   {
     "name": "VITE_NEW_FEATURE_FLAG",
     "type": "boolean",
     "description": "Enable new feature",
     "default": "true"
   }
   ```

4. **Update Documentation:**
   - Add to `ENV_SETUP_GUIDE.md`
   - Update `README.md` if user-facing

5. **Test Validation:**
   ```bash
   npm run validate-env
   ```

### Modifying Build Config

1. **Edit `buildConfig.js`:**
   ```javascript
   export const DEFAULT_PRELOADED_SECTIONS = [
     'auth',
     '404',
     'new-section'  // Add new preloaded section
   ];
   ```

2. **Restart Dev Server:**
   ```bash
   npm run dev
   ```

3. **Test Changes:**
   - Check network tab for preloaded bundles
   - Verify section loads correctly
   - Test lazy loading still works

---

## ðŸ§ª Testing

### Test Environment Validation

```bash
# Test with all env vars set
npm run validate-env

# Test with missing required var
VITE_COGNITO_USER_POOL_ID= npm run validate-env
# Should fail with error message

# Test with invalid value
VITE_ENABLE_LOGGER=invalid npm run validate-env
# Should fail with validation error
```

### Test Build Config

```bash
# Build with custom config
npm run build

# Check manifest files
ls -la dist/assets/*.manifest.json

# Verify section bundles
ls -la dist/assets/section-*
```

---

## ðŸ” Debugging

### Enable Debug Logging

```bash
# Set logger to true
export VITE_ENABLE_LOGGER=true

# Run build/dev
npm run dev
```

### Check Validation Results

```javascript
// In browser console
import('./src/utils/build/envValidator.js').then(m => {
  const result = m.validateEnvironmentVariables('development', import.meta.env);
  console.table(result);
});
```

### Inspect Build Config

```javascript
// In browser console or Node
import('./build/buildConfig.js').then(config => {
  console.log('Preloaded sections:', config.DEFAULT_PRELOADED_SECTIONS);
  console.log('Tailwind ignore:', config.TAILWIND_IGNORE_PATTERNS);
});
```

---

## ðŸ“š Related Documentation

- **Environment Setup:** `../../ENV_SETUP_GUIDE.md`
- **Developer Guide:** `../../DEV_GUIDE_COMPLETE.md`
- **Build System:** `../../../vite.config.js`
- **Manifest Generation:** `../../../build/vite/manifestGenerator.js`

---

## ðŸš¨ Important Notes

1. **Environment Variables:**
   - All client-side vars MUST be prefixed with `VITE_`
   - Validation runs on every build and app startup
   - Production builds fail if validation fails
   - Development shows warnings but continues

2. **Build Config:**
   - Changes require restart of dev server
   - Affects bundle generation and splitting
   - Modify with caution - impacts app performance

3. **Manifest Loading:**
   - Manifests generated during build
   - Different loading strategy for dev vs prod
   - Cached for performance
   - Clear cache if stale data

4. **Security:**
   - Never log actual secret values
   - Validate all user-provided env vars
   - Use placeholders in examples
   - Fail builds if secrets are missing

---

**Maintained By:** Development Team
**Last Updated:** 2024

